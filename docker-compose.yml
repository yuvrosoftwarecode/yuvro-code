services:
  # Observability Stack
  # Observability Stack
  # jaeger:
  #   image: jaegertracing/all-in-one:1.52
  #   ports:
  #     - "16686:16686"
  #     - "14268:14268"
  #   environment:
  #     - COLLECTOR_OTLP_ENABLED=true
  #   networks:
  #     - observability

  # otel-collector:
  #   image: otel/opentelemetry-collector-contrib:0.91.0
  #   command: ["--config=/etc/otel-collector-config.yaml"]
  #   volumes:
  #     - ./yc-observability/otel-collector-config.yaml:/etc/otel-collector-config.yaml
  #     - /var/lib/docker/containers:/var/lib/docker/containers:ro
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #   ports:
  #     - "4317:4317"   # OTLP gRPC receiver
  #     - "4318:4318"   # OTLP HTTP receiver
  #     - "8889:8889"   # Prometheus metrics
  #   depends_on:
  #     - jaeger
  #     - prometheus
  #     - loki
  #   networks:
  #     - observability

  # prometheus:
  #   image: prom/prometheus:v2.48.1
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./yc-observability/prometheus.yml:/etc/prometheus/prometheus.yml
  #     - prometheus_data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.console.libraries=/etc/prometheus/console_libraries'
  #     - '--web.console.templates=/etc/prometheus/consoles'
  #     - '--storage.tsdb.retention.time=200h'
  #     - '--web.enable-lifecycle'
  #   networks:
  #     - observability

  # loki:
  #   image: grafana/loki:3.0.0
  #   ports:
  #     - "3100:3100"
  #   command: -config.file=/etc/loki/local-config.yaml
  #   volumes:
  #     - ./yc-observability/loki-config.yaml:/etc/loki/local-config.yaml
  #     - loki_data:/loki
  #   environment:
  #     - JAEGER_AGENT_HOST=jaeger
  #     - JAEGER_ENDPOINT=http://jaeger:14268/api/traces
  #     - JAEGER_SAMPLER_TYPE=const
  #     - JAEGER_SAMPLER_PARAM=1
  #   networks:
  #     - observability

  # grafana:
  #   image: grafana/grafana:10.2.3
  #   ports:
  #     - "3001:3000"
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #   volumes:
  #     - grafana_data:/var/lib/grafana
  #     - ./yc-observability/grafana/provisioning:/etc/grafana/provisioning
  #     - ./yc-observability/grafana/dashboards:/var/lib/grafana/dashboards
  #   depends_on:
  #     - prometheus
  #     - loki
  #   networks:
  #     - observability

  db:
    image: postgres:15
    env_file:
      - ./yc-backend-api/.env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app
      - observability

  backend:
    build:
      context: ./yc-backend-api
      dockerfile: Dockerfile
    ports:
      - "8001:8000"  # Django API
      - "9001:9001"  # Prometheus metrics
    env_file:
      - ./yc-backend-api/.env
    environment:
      - OTEL_ENABLED=false
      #- OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      #- OTEL_SERVICE_NAME=yc-backend-api
      #- OTEL_RESOURCE_ATTRIBUTES=service.name=yc-backend-api,service.version=1.0.0
    volumes:
      - ./yc-backend-api:/app
    depends_on:
      db:
        condition: service_healthy
      # otel-collector:
      #   condition: service_started
    command: >
      sh -c "python manage.py migrate &&
             python manage.py runserver 0.0.0.0:8000"
    networks:
      - app
      - observability

  code-executor:
    build:
      context: ./yc-code-executor
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
      - "9002:9002"  # Prometheus metrics
    env_file:
      - ./yc-code-executor/.env
    environment:
      - OTEL_ENABLED=false
      #- OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      #- OTEL_SERVICE_NAME=yc-code-executor
      #- OTEL_RESOURCE_ATTRIBUTES=service.name=yc-code-executor,service.version=1.0.0
    volumes:
      - ./yc-code-executor:/app
    # depends_on:
    #   - otel-collector
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - app
      - observability

  frontend:
    build:
      context: ./yc-web
      dockerfile: Dockerfile
      target: development
    ports:
      - "3000:3000"
    env_file:
      - ./yc-web/.env
    environment:
      - VITE_OTEL_ENABLED=false
      #- VITE_OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
      #- VITE_OTEL_LOGS_ENDPOINT=http://localhost:4318/v1/logs
      #- VITE_OTEL_SERVICE_NAME=yc-web
      #- VITE_OTEL_RESOURCE_ATTRIBUTES=service.name=yc-web,service.version=1.0.0
    volumes:
      - ./yc-web:/app
      - /app/node_modules
    stdin_open: true
    tty: true
    depends_on:
      - backend
      - code-executor
      # - otel-collector
    command: npm run dev -- --host 0.0.0.0
    networks:
      - app
      - observability

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  loki_data:

networks:
  app:
    driver: bridge
  observability:
    driver: bridge
